{% extends "base.html" %}
{% block title %}Detalhes do Pedido #{{ pedido.id }}{% endblock %}

{% block content %}
<div class="page-container">

  <div class="pedido-card">
    <h2 class="admin-title" style="text-align:center;">
      ‚öôÔ∏è Detalhes do Pedido #{{ pedido.id }}
    </h2>

    <!-- INFORMA√á√ïES DO PEDIDO -->
    <div class="pedido-info" style="margin-bottom:25px; text-align:center;">
      <p><strong>Cliente:</strong> {{ pedido.usuario.nome }}</p>
      <p><strong>E-mail:</strong> {{ pedido.usuario.email }}</p>
      <p><strong>Data:</strong> {{ pedido.data_pedido.strftime('%d/%m/%Y %H:%M') if pedido.data_pedido else '-' }}</p>
      <p>
        <strong>Status atual:</strong>
        <span class="status-badge status-{{ pedido.status|lower|replace(' ', '-') }}">
          {{ pedido.status }}
        </span>
      </p>

      <!-- ‚≠ê AVALIA√á√ÉO DO PEDIDO -->
          {% if pedido.avaliacao %}
          <p style="margin-top:10px;">
            <strong>Avalia√ß√£o do Cliente:</strong>
          </p>
          <div style="font-size:28px; color:#f7c325;">
            {% for i in range(1, 6) %}
              {% if i <= pedido.avaliacao %}‚òÖ{% else %}‚òÜ{% endif %}
            {% endfor %}
          </div>
          {% endif %}
        </div>

         

    <!-- LINHA DO TEMPO HORIZONTAL -->
    <div class="status-timeline">
      {% set etapas = [
        ('Recebido', 'üì•'),
        ('Em produ√ß√£o', 'üë©‚Äçüç≥'),
        ('Pronto', '‚úÖ'),
        ('Entregue', 'üì¶')
      ] %}
      {% set nomes = etapas | map(attribute=0) | list %}

      {% if pedido.status in nomes %}
        {% set atual = nomes.index(pedido.status) %}
      {% else %}
        {% set atual = 0 %}
      {% endif %}

      {% for nome, icone in etapas %}
      <div class="status-step 
                  {% if loop.index0 == atual %}ativo
                  {% elif loop.index0 < atual %}completo{% endif %}">

        <div class="status-icon">{{ icone }}</div>
        <div class="status-label">{{ nome }}</div>

        {% if not loop.last %}
        <div class="status-bar {% if loop.index0 < atual %}completo{% endif %}"></div>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <!-- ITENS DO PEDIDO -->
    <div class="table-wrapper">
      <table class="table-admin">
        <thead>
          <tr>
            <th>Item</th>
            <th>Qtd</th>
            <th>Unit√°rio</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody>
          {% for item in pedido.itens %}
          <tr>
            <td>{{ item.cupcake.nome if item.cupcake else 'Item removido' }}</td>
            <td>{{ item.quantidade }}</td>
            <td>R$ {{ "%.2f"|format(item.cupcake.preco if item.cupcake else 0) }}</td>
            <td><strong>R$ {{ "%.2f"|format((item.quantidade or 0) * (item.cupcake.preco if item.cupcake else 0)) }}</strong></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- TOTAL -->
    <h3 style="text-align:right;margin-top:15px;">
      Total: <strong>R$ {{ "%.2f"|format(total or pedido.total or 0) }}</strong>
    </h3>

    <!-- A√á√ïES ADMINISTRATIVAS -->
    <div style="margin-top:30px; text-align:center;">
      <form action="{{ url_for('admin_atualiza_status', pedido_id=pedido.id) }}" method="POST"
            style="display:inline-block; margin-right:10px;">
        <select name="status" class="small-select">
          {% for s in ['Recebido','Em produ√ß√£o','Pronto','Entregue','Cancelado'] %}
            <option value="{{ s }}" {% if pedido.status == s %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
        <button class="btn-primary btn-small">Atualizar Status</button>
      </form>
    

      <form action="{{ url_for('admin_cancelar_pedido', pedido_id=pedido.id) }}" method="POST"
            style="display:inline-block; margin-right:10px;"
            onsubmit="return confirm('Tem certeza que deseja cancelar o pedido #{{ pedido.id }}?');">
        <button class="btn-danger btn-small">Cancelar Pedido</button>
      </form>

      <!-- BOT√ÉO PDF (novo) -->
      <a href="{{ url_for('pedido_pdf', pedido_id=pedido.id) }}"
        target="_blank"
        class="btn-danger btn-small"
        style="display:inline-block; margin-right:10px; padding:8px 12px;">
          üìÑ Download PDF
      </a>

      <form action="{{ url_for('admin_pedido_delete', pedido_id=pedido.id) }}" method="POST"
            style="display:inline;"
            onsubmit="return confirm('Excluir pedido #{{ pedido.id }}?');">
         <button class="btn-small btn-danger">üóë Excluir</button>
      </form>

      <a href="{{ url_for('admin_dashboard') }}" class="btn-secondary btn-small">‚¨Ö Voltar ao Painel</a>
    </div>

  </div>
</div>
{% endblock %}
